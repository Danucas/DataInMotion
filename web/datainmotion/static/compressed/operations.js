let stoped=!1;async function running_test(t){window.scrollTo(0,0),stoped=!1,$('[stop="true"]').on("click",async function(){stoped=!0,$(".last_state h1").html("Stopping process ..."),await stopProcess(t),$(".loading").css("display","none")}),localStorage.running_test=!0,localStorage.running_id=t;let e=!1,o=!1;for($(".loading ul").empty(),$(".html_viewer").empty();!stoped;){await timeSleep(2e3);const s=await fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/check_response?id=${t}`,{method:"GET",headers:{Accept:"application/json"}});let n=await s.json();for(mess of("choose_gif"!==n.status&&(o=!1),stoped||$(".last_state h1").html(n.messages[n.messages.length-1]),$(".loading ul").empty(),n.messages.reverse())){const t=$(`<li>${mess}</li>`);$(".loading ul").append($(t))}if("completed"===n.status){$(".loading").css("display","none"),localStorage.removeItem("running_id"),localStorage.removeItem("running_test"),showConsole(n.logger);break}if("verifying"===n.status){if(!1===e){const o=await fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/web_whatsapp_verify?id=${t}`,{method:"GET"}),s=await o.text(),n=$(s);""!==s&&"Failed"!==s&&(e=!0),$(".qr").css("display","block"),$(".qr").append($(n)),$(".close_qr").on("click",function(t){$(".qr").css("display","none")})}}else{if("choose_gif"!==n.status){if("error"===n.status){$(".loading").css("display","none");break}$(".qr").empty(),$(".qr").css("display","none"),$(".html_viewer").empty(),$(".html_viewer").css("display","none");continue}{const e=n.messages.length-1;if(!o){const e=await fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/choose_gif?id=${t}`),s=await e.text();$(".html_viewer").empty(),$(".html_viewer").html(s),$(".html_viewer").css("display","block"),o=!0}n.messages[e]}}}}function getDate(){const t=new Date(Date.now());return[t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()]}class OnOffButton{constructor(t,e){this.state=t,this.nodeId=e}async saveState(){const t=await fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/nodes/${this.nodeId}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token")}}),e=await t.json();"off"===this.state?e.analisis_params.active=!0:e.analisis_params.active=!1;const o=await fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/nodes/${this.nodeId}/save`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token")},body:JSON.stringify(e)});await o.json();getBoardView()}}function setOpsListeners(){$(".trigger_button").on("click",async function(t){const e=$(this).attr("n_id");new OnOffButton($(this).attr("state"),e).saveState(),document.querySelector(".hover_activate")&&document.querySelector(".hover_activate").remove()});let t=!1;$(".trigger_button").mouseover(function(e){if(!t){t=!0;const o=document.createElement("h1");o.className="hover_activate";const s=e.target.getBoundingClientRect();if(o.style.top=s.top-45+document.body.scrollTop,o.style.left=s.left+document.body.scrollLeft,"active"===$(this).attr("state")){const t=$(this).attr("next");o.innerHTML=`<span style="color: rgb(11, 213, 169);">Active: </span>next run -> ${t.split(" ")[1]} ${t.split(" ")[0]}`}else o.innerHTML='state:<span style="color: red;"> Off</span>';document.body.appendChild(o),$(this).mouseleave(function(e){t=!1,o.remove()})}}),$(".test_button").on("click",function(t){const e=$(this).attr("n_id");setTimeout("",3e3),$(".new_node_cont").css("display","none"),$(".loading").css("display","block"),$.ajax({url:`${global.prot}://${global.domain}${global.apiPort}/api/v1/nodes/${e}/run`,crossDomain:!0,contentType:"application/json",dataType:"json",headers:{"Access-Control-Allow-Origin":"*"},success:function(t){running_test(t.instance)},error:function(t){$(".loading").css("display","none")}})})}async function timeSleep(t){return new Promise(e=>setTimeout(e,t))}