class NodeEditor{constructor(e,t){this.root=e;const n=document.querySelector("#canvas_connections");n&&(this.root.parentNode.style.width=n.style.width,this.root.parentNode.style.height=n.style.height),this.id=t,this.getData(),this.setClose(),this.title=document.querySelector(".title"),this.description=document.querySelector(".description")}setpos(e){this.root.style.top=e.pageY-100,this.root.style.left=e.pageX;const t=document.querySelector(".close_node");t.style.left=e.pageX,t.style.top=e.pageY-110}setClose(){const e=this,t=document.querySelector(".close_node");t.addEventListener("click",function n(){t.removeEventListener("click",n),e.close()})}close(){this.calendar&&this.calendar.close();const e=document.querySelector(".next"),t=this.root.querySelector(".back");e.removeEventListener("click",this.goNext),t.removeEventListener("click",this.goBack),this.root.parentNode.style.display="none"}getData(){const e=`${global.prot}://${global.domain}${global.apiPort}/api/v1/nodes/${this.id}`;fetch(e,{method:"GET",headers:{Authorization:localStorage.getItem("token")}}).then(e=>{if(200===e.status)return e.json()}).then(e=>{this.data=e,this.renderNodeName()})}renderNodeName(){this.title.innerHTML="Node name",this.description.innerHTML="Give your node the name that describes it the best!";const e=document.createElement("div");e.innerHTML=`<label>Node name</label><input type="text" placeholder="Node name" value="${this.data.name}">`;const t=document.getElementById("cont");t.innerHTML="",t.appendChild(e);const n=document.querySelector(".next"),a=this.root.querySelector(".back");n.innerHTML="next";const i=this;i.goNext=function(){if(n.removeEventListener("click",i.goNext),a.removeEventListener("click",i.goBack),i.data.name=e.querySelector("input").value,"service"===i.data.type)i.renderCalendar();else{document.querySelector(".back");"request"===i.data.work_type?i.renderUrl():"process"===i.data.work_type&&i.renderProcess()}},i.goBack=function(){n.removeEventListener("click",i.goNext),a.removeEventListener("click",i.goBack),i.close()},n.addEventListener("click",i.goNext),a.addEventListener("click",i.goBack)}renderServiceOptions(){}printFormatedDate(e,t){const n=["January","February","March","April","May","June","July","August","September","October","November","December"][t[1]];e.innerHTML=`${n} ${t[2]} ${t[0]}<br>${t[3]}:${t[4]}`}renderCalendar(){const e=this,t=new DOMParser;this.title.innerHTML="Trigger configuration",this.description.innerHTML="Select a start date and a frequency to setup the alert";const n=document.getElementById("cont");n.innerHTML="";const a=document.createElement("button");a.className="select_date",a.innerHTML="select date";const i=document.createElement("h1");if(i.style.textAlign="center",e.triggerDateContainer=i,e.data.analisis_params.date){const t=e.data.analisis_params.date.map(e=>Array.isArray(e)?e.clone():e);t[1]-=1,e.printFormatedDate(i,t)}a.addEventListener("click",function(t){let n=e.data.analisis_params.date;n?n[1]>0?n[1]=n[1]-1:n[1]=0:n=Date.now();const a=new Calendar(n,e.data.id,document.body);a.context=e,e.calendar=a;const i=t.target.getBoundingClientRect();a.build(i.left-40+document.body.scrollLeft,t.pageY-150).then(()=>{a._html.style.position="absolute"})});const s=document.createElement("div"),o=document.createElement("div");s.appendChild(o),s.appendChild(i),s.appendChild(a),s.appendChild(t.parseFromString("<label>FREQUENCY</label>","text/html").body.firstChild);const c=["hourly","daily","weekly","monthly"],r=document.createElement("select");for(const e of c){const t=document.createElement("option");t.value=e,t.innerHTML=e,r.appendChild(t)}r.value=e.data.analisis_params.frequency,o.classList=["active_container"];const d=document.createElement("h1");d.innerHTML="";const l=document.createElement("div"),u=document.createElement("h3");function m(){e.data.analisis_params.active?(d.innerHTML="Active",l.classList.add("active"),l.classList.remove("off")):(d.innerHTML="Off",l.classList.add("off"),l.classList.remove("active"));const t=getComputedStyle(u);setTimeout(()=>{d.style.color=t["background-color"]},600)}l.appendChild(u),o.appendChild(d),o.appendChild(l),l.classList.add("activation_slide"),m(),l.addEventListener("click",function(){e.data.analisis_params.active?e.data.analisis_params.active=!1:e.data.analisis_params.active=!0,m()}),s.appendChild(r),n.innerHTML="",n.appendChild(s);const p=document.querySelector(".next");p.innerHTML="save and exit";const v=this.root.querySelector(".back");e.goNext=function(){p.removeEventListener("click",e.goNext),v.removeEventListener("click",e.goBack);const t=new Date(Date.now());e.data.analisis_params.sync_date=[t.getFullYear(),t.getMonth()+1,t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()],e.data.analisis_params.frequency=r.value,e.save()},e.goBack=function(){p.removeEventListener("click",e.goNext),v.removeEventListener("click",e.goBack),e.renderNodeName()},p.addEventListener("click",e.goNext),v.addEventListener("click",e.goBack)}renderUrl(){const e=this;this.title.innerHTML="Request Configuration",this.description.innerHTML='Use "GET" or "POST" at the begining followed by a space to specify the method to this request.';const t=document.createElement("div");t.innerHTML=`<label>URL</label><input type="text" placeholder="Ex. GET http://webpage.com" value="${this.data.api_url}">`;const n=document.getElementById("cont");n.innerHTML="",n.appendChild(t);const a=document.createElement("div");a.className="head_cont";const i=document.createElement("p");i.innerHTML="HEADERS",n.appendChild(i);let s=[0,0];n.appendChild(a),function t(){let n='<div class="fields"><h1>KEY</h1><h1>VALUE</h1></div>',i=0;for(const t in e.data.headers)n+=`<div name="row" index="${i}" class="row"><input type="text" placeholder="Key" value="${t}">`,n+=`<input type="text" placeholder="Value" value='${e.data.headers[t]}'></div>`,i++;n+='<div class="row"><input name="new" type="text" placeholder="Key" value="">',n+='<input type="text" placeholder="Value" value=""></div>',a.innerHTML=n,document.querySelectorAll('[name="row"]').forEach(n=>{const a=n.querySelectorAll("input");Number(n.getAttribute("index"))===s[0]&&(a[s[1]].focus(),a[s[1]].selectionStart=a[s[1]].selectionEnd=a[s[1]].value.length),a[0].addEventListener("input",function i(o){a[0].removeEventListener("input",i),s=[Number(n.getAttribute("index")),0];const c=o.target.value;let r=c.slice(0,-1);if("deleteContentBackward"===o.inputType)for(const t in e.data.headers)t.slice(0,-1)===c&&(r=t);const d=e.data.headers[r];e.data.headers[c]=d,delete e.data.headers[r],t()}),a[1].addEventListener("change",function i(o){a[1].removeEventListener("change",i),s=[Number(n.getAttribute("index")),1];const c=a[0].value.toString();e.data.headers[c]=o.target.value,t()})});const o=document.querySelector('[name="new"]');o.addEventListener("input",function n(a){s=[i,0],o.removeEventListener("change",n),e.data.headers[a.target.value]="",a.target.value="",t()})}();const o=document.createElement("div");o.className="query_cont";const c=document.createElement("p");c.innerHTML="QUERY DATA",n.appendChild(c);let r=[0,0];n.appendChild(o),function t(){let n='<div class="fields"><h1>KEY</h1><h1>VALUE</h1></div>',a=0;for(const t in e.data.data)n+=`<div name="row" index="${a}" class="row"><input type="text" placeholder="Key" value="${t}">`,n+=`<input type="text" placeholder="Value" value='${e.data.data[t]}'></div>`,a++;n+='<div class="row"><input name="new_q" type="text" placeholder="Key" value="">',n+='<input type="text" placeholder="Value" value=""></div>',o.innerHTML=n,document.querySelectorAll('.query_cont [name="row"]').forEach(n=>{const a=n.querySelectorAll("input");Number(n.getAttribute("index"))===s[0]&&(a[s[1]].focus(),a[s[1]].selectionStart=a[s[1]].selectionEnd=a[s[1]].value.length),a[0].addEventListener("input",function i(s){a[0].removeEventListener("input",i),r=[Number(n.getAttribute("index")),0];const o=s.target.value;let c=o.slice(0,-1);if("deleteContentBackward"===s.inputType)for(const t in e.data.data)t.slice(0,-1)===o&&(c=t);const d=e.data.data[c];e.data.data[o]=d,delete e.data.data[c],t()}),a[1].addEventListener("change",function i(o){a[1].removeEventListener("change",i),s=[Number(n.getAttribute("index")),1];const c=a[0].value.toString();e.data.data[c]=o.target.value,t()})});const i=document.querySelector('[name="new_q"]');i.addEventListener("input",function n(s){r=[a,0],i.removeEventListener("change",n),e.data.data[s.target.value]="",s.target.value="",t()})}();const d=document.querySelector(".next");d.innerHTML="next";const l=this.root.querySelector(".back");e.goNext=function(){d.removeEventListener("click",e.goNext),l.removeEventListener("click",e.goBack),e.renderProcess()},e.goBack=function(){d.removeEventListener("click",goNext),l.removeEventListener("click",goBack),e.renderNodeName()},d.addEventListener("click",e.goNext),l.addEventListener("click",e.goBack)}renderProcess(){const e=this;this.title.innerHTML="Process Configuration",this.description.innerHTML='Setup the "process mode" and check the "info" tag to get a "how to do" about the choosed mode';const t=document.createElement("select"),n=["","statistics","comparision","replace","JSON","HTML","media_player","media_twitter","contacts_list","list_ops"];for(const e of n){const n=document.createElement("option");n.setAttribute("value",e),n.innerHTML=e,t.appendChild(n)}const a=document.getElementById("cont");a.innerHTML="";const i=document.createElement("label");i.innerHTML="Process mode",a.appendChild(i),a.appendChild(t),t.querySelector(`[value="${e.data.analisis_mode}"]`).setAttribute("selected","true"),t.addEventListener("change",function(t){e.data.analisis_mode=t.target.value,e.data.analisis_params=[{}],e.getProcessView(e.data.analisis_mode)}),e.getProcessView(e.data.analisis_mode);const s=document.querySelector(".next"),o=this.root.querySelector(".back");s.innerHTML="save and exit",e.goNext=function(){s.removeEventListener("click",e.goNext),o.removeEventListener("click",e.goBack),setTimeout(function(){},100),e.save()},e.goBack=function(){s.removeEventListener("click",e.goNext),o.removeEventListener("click",e.goBack),"process"===e.data.work_type?e.renderNodeName():e.renderUrl()},s.addEventListener("click",e.goNext),o.addEventListener("click",e.goBack)}getProcessView(e){const t=this,n=document.getElementById("cont"),a=n.querySelector("select"),i=n.querySelector("label");return n.innerHTML="","replace"!==e&&(t.data.string=""),n.appendChild(i),n.appendChild(a),{statistics:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="samples_cont";const a=document.createElement("p");a.innerHTML="POPULATION";let i=[],s=[],o=[0,0];try{i=Object.keys(t.data.analisis_params[0].samples),s=Object.keys(t.data.analisis_params[0].parameters)}catch(e){}e.appendChild(a),e.appendChild(n),function e(){let a='<div class="fields"><h1>PARAMETERS</h1><h1>SAMPLES</h1></div>';a+='<div class="row"><div column="left"></div><div column="right"></div></div>',n.innerHTML=a;const c=document.querySelector('[column="right"]');let r=0;if("samples"in t.data.analisis_params[0])for(const n of i){if(""===n||void 0===n)return i.splice(r,1),void e();const a=document.createElement("input");a.setAttribute("index",r),a.value=n,c.append(a),a.addEventListener("change",function(n){if(""===n.target.value){delete i[n.target.getAttribute("index")];const e=[];for(const t of i)t&&e.push(t);t.data.analisis_params[0].samples=e,i=e}else i[n.target.getAttribute("index")]=n.target.value;e()}),o[0]===r&&1===o[1]&&(a.focus(),a.selectionStart=a.selectionEnd=a.value.length),r++}const d=document.createElement("input");d.addEventListener("change",function n(a){if(""!==a.target.value){d.removeEventListener("change",n);const s=a.target.value;i.push(s),o=[i.length-1,1];const c={};for(const e of i)c[e]=!0;t.data.analisis_params[0].samples=c,e()}}),c.appendChild(d),r=0;const l=document.querySelector('[column="left"]');if("parameters"in t.data.analisis_params[0])for(const n of s){if(""===n||void 0===n)return s.splice(r,1),void e();const a=document.createElement("input");a.setAttribute("index",r),a.value=n,l.append(a),a.addEventListener("change",function(n){if(""===n.target.value){delete s[n.target.getAttribute("index")];const e=[];for(const t of s)t&&e.push(t);t.data.analisis_params[0].parameters=e,s=e}e()}),o[0]===r&&0===o[1]&&(a.focus(),a.selectionStart=a.selectionEnd=a.value.length),r++}const u=document.createElement("input");u.addEventListener("change",function n(a){if(""!==a.target.value){u.removeEventListener("change",n);const i=a.target.value;s.push(i),o=[s.length-1,1];const c={};for(const e of s)c[e]=!0;t.data.analisis_params[0].parameters=c,e()}}),l.appendChild(u)}()},comparision:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="samples_cont";const a=document.createElement("p");a.innerHTML="CONDITIONS",e.appendChild(a),e.appendChild(n),function e(){let a='<div class="fields cond"><h1>VALUE 1</h1><h1>CONDITION</h1><h1>VALUE 2</h1></div>';const i=["==","<",">","in"];function s(e){let t="";e.input&&(t='name="add"');let n=`<div class="row cond" ${t}>`;n+=`<input class="cond_input" value="${e.key}">`,n+='<select class="cond_select">';for(const t of i){let a="";t===e.cond&&(a='selected="true"'),n+=`<option value="${t}" ${a}">"${t}"</option>`}return n+="</select>",n+=`<input class="cond_input" value="${e.comp}">`,n+="</div>"}if(t.data.analisis_params[0]&&"cond"in t.data.analisis_params[0])for(const e of t.data.analisis_params)a+=s(e);a+=s({cond:"==",key:"",comp:"",input:!0}),n.innerHTML=a;const o=document.querySelectorAll(".row");for(let n=0;n<o.length-1;n++){const a=o[n].querySelectorAll("input"),i=o[n].querySelector("select");a[0].addEventListener("change",function i(s){if(a[0].removeEventListener("change",i),""===s.target.value){if(0===n&&1===t.data.analisis_params.length)t.data.analisis_params[n]={};else{delete t.data.analisis_params[n];const e=[];for(const n of t.data.analisis_params)n&&e.push(n);t.data.analisis_params=e}e()}else t.data.analisis_params[n].key=s.target.value;a[0].addEventListener("change",i)}),a[1].addEventListener("change",function e(i){a[1].removeEventListener("change",e),t.data.analisis_params[n].comp=i.target.value,a[1].addEventListener("change",e)}),i.addEventListener("change",function e(a){i.removeEventListener("change",e),t.data.analisis_params[n].cond=a.target.value,i.addEventListener("change",e)})}const c=document.querySelector('[name="add"] input');c.addEventListener("change",function n(a){c.removeEventListener("change",n),t.data.analisis_params.length>=1&&"key"in t.data.analisis_params[0]?t.data.analisis_params.push({key:a.target.value,cond:"==",comp:""}):t.data.analisis_params[0]={key:a.target.value,cond:"==",comp:""},e()})}()},replace:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="message_cont";const a=document.createElement("p");a.innerHTML="MESSAGE",e.appendChild(a),e.appendChild(n),function(){n.innerHTML='<textarea type="text" wrap="hard" cols="10" rows="2"></textarea>';const e=document.querySelector(".message_cont textarea");e.value=t.data.string,e.addEventListener("change",function(e){t.data.string=e.target.value})}()},JSON:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="json_cont";const a=document.createElement("p");a.innerHTML="VALUES",e.appendChild(a),e.appendChild(n),function e(){for(;n.hasChildNodes();)n.removeChild(n.firstChild);function a(a){const i=document.createElement("div");i.className="row";const s=document.createElement("input"),o=document.createElement("input");void 0!==a?(s.value=t.data.analisis_params[a].key,o.value=t.data.analisis_params[a].path,s.addEventListener("change",function(e){t.data.analisis_params[a].key=e.target.value}),o.addEventListener("change",function(e){t.data.analisis_params[a].path=e.target.value})):(s.addEventListener("change",function n(a){s.removeEventListener("change",n),t.data.analisis_params.push({key:a.target.value,path:""}),e()}),o.addEventListener("change",function n(a){o.removeEventListener("change",n),t.data.analisis_params.push({key:"",path:a.target.value}),e()})),i.appendChild(s),i.appendChild(o),n.appendChild(i)}n.innerHTML="",n.innerHTML='<div class="fields"><h1>SAVE AS</h1><h1>PATH FROM FLOW</h1></div>';for(let e=0;e<t.data.analisis_params.length&&"key"in t.data.analisis_params[e];e++)a(e);a(void 0)}()},HTML:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="html_cont";const a=document.createElement("p");a.innerHTML="VALUES",e.appendChild(a),e.appendChild(n),function e(){function a(a){const i=document.createElement("div");i.className="row";const s=document.createElement("input"),o=document.createElement("input");void 0!==a?(s.value=t.data.analisis_params[a].occurrence,o.value=t.data.analisis_params[a].stop,s.addEventListener("change",function(e){t.data.analisis_params[a].occurrence=e.target.value}),o.addEventListener("change",function(e){t.data.analisis_params[a].stop=e.target.value})):s.addEventListener("change",function n(a){s.removeEventListener("change",n),t.data.analisis_params.length>=1&&"stop"in t.data.analisis_params[0]?t.data.analisis_params.push({occurrence:a.target.value,stop:"",discard:!1}):t.data.analisis_params[0]={occurrence:a.target.value,stop:"",discard:!1},e()}),i.appendChild(s),i.appendChild(o),n.appendChild(i)}n.innerHTML="",n.innerHTML='<div class="fields"><h1>OCCURRENCE</h1><h1>STOP SEQUENCE</h1></div>';for(let e=0;e<t.data.analisis_params.length;e++)"occurrence"in t.data.analisis_params[e]&&a(e);a(void 0)}()},get_updates:function(){},media_player:function(){const e=document.getElementById("cont");document.createElement("div").className="format_cont";const t=document.createElement("p");t.innerHTML="This proccess is automatic, continue by saving this configuration and exit",e.appendChild(t)},media_twitter:function(){const e=document.getElementById("cont");document.createElement("div").className="format_cont";const t=document.createElement("p");t.innerHTML="This proccess is automatic, continue by saving this configuration and exit",e.appendChild(t)},contacts_list:function(){const e=document.getElementById("cont");document.createElement("div").className="format_cont";const t=document.createElement("p");t.innerHTML="This proccess is automatic, continue by saving this configuration and exit",e.appendChild(t)},list_ops:function(){const e=document.getElementById("cont"),n=document.createElement("div");n.className="samples_cont";const a=document.createElement("p");a.innerHTML="LISTS AND OPERATIONS",e.appendChild(a),e.appendChild(n),function e(){let a='<div class="fields cond"><h1>LIST NAME</h1><h1>OPERATION</h1><h1>VALUE IN LIST ITEM</h1></div>';const i=["+","-","*","/"];function s(e){let t="";e.input&&(t='name="add"');let n=`<div class="row cond" ${t}>`;n+=`<input class="cond_input" value="${e.list}">`,n+='<select class="cond_select">';for(const t of i){let a="";t===e.opt&&(a='selected="true"'),n+=`<option value="${t}" ${a}">"${t}"</option>`}return n+="</select>",n+=`<input class="cond_input" value="${e.value}">`,n+="</div>"}if("list"in t.data.analisis_params[0])for(const e of t.data.analisis_params)a+=s(e);a+=s({opt:"+",list:"",value:"",input:!0}),n.innerHTML=a;const o=document.querySelectorAll(".row");for(let n=0;n<o.length-1;n++){const a=o[n].querySelectorAll("input"),i=o[n].querySelector("select");a[0].addEventListener("change",function i(s){if(a[0].removeEventListener("change",i),""===s.target.value){if(0===n&&1===t.data.analisis_params.length)t.data.analisis_params[n]={};else{delete t.data.analisis_params[n];const e=[];for(const n of t.data.analisis_params)n&&e.push(n);t.data.analisis_params=e}e()}else t.data.analisis_params[n].list=s.target.value;a[0].addEventListener("change",i)}),a[1].addEventListener("change",function e(i){a[1].removeEventListener("change",e),t.data.analisis_params[n].value=i.target.value,a[1].addEventListener("change",e)}),i.addEventListener("change",function e(a){i.removeEventListener("change",e),t.data.analisis_params[n].opt=a.target.value,i.addEventListener("change",e)})}const c=document.querySelector('[name="add"] input');c.addEventListener("change",function n(a){c.removeEventListener("change",n),t.data.analisis_params.length>=1&&"list"in t.data.analisis_params[0]?t.data.analisis_params.push({list:a.target.value,opt:"+",value:""}):t.data.analisis_params[0]={list:a.target.value,opt:"+",value:""},e()})}()},"":function(){}}[e]()}save(){fetch(`${global.prot}://${global.domain}${global.apiPort}/api/v1/nodes/${this.data.id}/save`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token")},body:JSON.stringify(this.data)}).then(e=>e.json).then(e=>{getBoardView(),$(".new_node_cont").css("display","none")})}}